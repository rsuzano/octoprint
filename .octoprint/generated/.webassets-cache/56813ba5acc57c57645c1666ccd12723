V// source: js/app/viewmodels/control.js\u000a$(function() {\u000a    function ControlViewModel(parameters) {\u000a        var self = this;\u000a\u000a        self.loginState = parameters[0];\u000a        self.settings = parameters[1];\u000a\u000a        self._createToolEntry = function () {\u000a            return {\u000a                name: ko.observable(),\u000a                key: ko.observable()\u000a            }\u000a        };\u000a\u000a        self.isErrorOrClosed = ko.observable(undefined);\u000a        self.isOperational = ko.observable(undefined);\u000a        self.isPrinting = ko.observable(undefined);\u000a        self.isPaused = ko.observable(undefined);\u000a        self.isError = ko.observable(undefined);\u000a        self.isReady = ko.observable(undefined);\u000a        self.isLoading = ko.observable(undefined);\u000a\u000a        self.extrusionAmount = ko.observable(undefined);\u000a        self.controls = ko.observableArray([]);\u000a\u000a        self.distances = ko.observableArray([0.1, 1, 10, 100]);\u000a        self.distance = ko.observable(10);\u000a\u000a        self.tools = ko.observableArray([]);\u000a\u000a        self.feedRate = ko.observable(100);\u000a        self.flowRate = ko.observable(100);\u000a\u000a        self.feedbackControlLookup = {};\u000a\u000a        self.controlsFromServer = [];\u000a        self.additionalControls = [];\u000a\u000a        self.webcamDisableTimeout = undefined;\u000a        self.webcamLoaded = ko.observable(false);\u000a        self.webcamError = ko.observable(false);\u000a\u000a        self.keycontrolActive = ko.observable(false);\u000a        self.keycontrolHelpActive = ko.observable(false);\u000a        self.keycontrolPossible = ko.pureComputed(function () {\u000a            return self.settings.feature_keyboardControl() && self.isOperational() && !self.isPrinting() && self.loginState.isUser() && !$.browser.mobile;\u000a        });\u000a        self.showKeycontrols = ko.pureComputed(function () {\u000a            return self.keycontrolActive() && self.keycontrolPossible();\u000a        });\u000a\u000a        self.webcamRatioClass = ko.pureComputed(function() {\u000a            if (self.settings.webcam_streamRatio() == "4:3") {\u000a                return "ratio43";\u000a            } else {\u000a                return "ratio169";\u000a            }\u000a        });\u000a\u000a        self.settings.printerProfiles.currentProfileData.subscribe(function () {\u000a            self._updateExtruderCount();\u000a            self.settings.printerProfiles.currentProfileData().extruder.count.subscribe(self._updateExtruderCount);\u000a        });\u000a        self._updateExtruderCount = function () {\u000a            var tools = [];\u000a\u000a            var numExtruders = self.settings.printerProfiles.currentProfileData().extruder.count();\u000a            if (numExtruders > 1) {\u000a                // multiple extruders\u000a                for (var extruder = 0; extruder < numExtruders; extruder++) {\u000a                    tools[extruder] = self._createToolEntry();\u000a                    tools[extruder]["name"](gettext("Tool") + " " + extruder);\u000a                    tools[extruder]["key"]("tool" + extruder);\u000a                }\u000a            } else if (numExtruders === 1) {\u000a                // only one extruder, no need to add numbers\u000a                tools[0] = self._createToolEntry();\u000a                tools[0]["name"](gettext("Hotend"));\u000a                tools[0]["key"]("tool0");\u000a            }\u000a\u000a            self.tools(tools);\u000a        };\u000a\u000a        self.fromCurrentData = function (data) {\u000a            self._processStateData(data.state);\u000a        };\u000a\u000a        self.fromHistoryData = function (data) {\u000a            self._processStateData(data.state);\u000a        };\u000a\u000a        self._processStateData = function (data) {\u000a            self.isErrorOrClosed(data.flags.closedOrError);\u000a            self.isOperational(data.flags.operational);\u000a            self.isPaused(data.flags.paused);\u000a            self.isPrinting(data.flags.printing);\u000a            self.isError(data.flags.error);\u000a            self.isReady(data.flags.ready);\u000a            self.isLoading(data.flags.loading);\u000a        };\u000a\u000a        self.onEventSettingsUpdated = function (payload) {\u000a            // the webcam url might have changed, make sure we replace it now if the tab is focused\u000a            self._enableWebcam();\u000a            self.requestData();\u000a        };\u000a\u000a        self.onEventRegisteredMessageReceived = function(payload) {\u000a            if (payload.key in self.feedbackControlLookup) {\u000a                var outputs = self.feedbackControlLookup[payload.key];\u000a                _.each(payload.outputs, function(value, key) {\u000a                    if (outputs.hasOwnProperty(key)) {\u000a                        outputs[key](value);\u000a                    }\u000a                });\u000a            }\u000a        };\u000a\u000a        self.rerenderControls = function () {\u000a            var allControls = self.controlsFromServer.concat(self.additionalControls);\u000a            self.controls(self._processControls(allControls))\u000a        };\u000a\u000a        self.requestData = function () {\u000a            OctoPrint.control.getCustomControls()\u000a                .done(function(response) {\u000a                    self._fromResponse(response);\u000a                });\u000a        };\u000a\u000a        self._fromResponse = function (response) {\u000a            self.controlsFromServer = response.controls;\u000a            self.rerenderControls();\u000a        };\u000a\u000a        self._processControls = function (controls) {\u000a            for (var i = 0; i < controls.length; i++) {\u000a                controls[i] = self._processControl(controls[i]);\u000a            }\u000a            return controls;\u000a        };\u000a\u000a        self._processControl = function (control) {\u000a            if (control.hasOwnProperty("processed") && control.processed) {\u000a                return control;\u000a            }\u000a\u000a            if (control.hasOwnProperty("template") && control.hasOwnProperty("key") && control.hasOwnProperty("template_key") && !control.hasOwnProperty("output")) {\u000a                control.output = ko.observable(control.default || "");\u000a                if (!self.feedbackControlLookup.hasOwnProperty(control.key)) {\u000a                    self.feedbackControlLookup[control.key] = {};\u000a                }\u000a                self.feedbackControlLookup[control.key][control.template_key] = control.output;\u000a            }\u000a\u000a            if (control.hasOwnProperty("children")) {\u000a                control.children = ko.observableArray(self._processControls(control.children));\u000a                if (!control.hasOwnProperty("layout") || !(control.layout == "vertical" || control.layout == "horizontal" || control.layout == "horizontal_grid")) {\u000a                    control.layout = "vertical";\u000a                }\u000a\u000a                if (!control.hasOwnProperty("collapsed")) {\u000a                    control.collapsed = false;\u000a                }\u000a            }\u000a\u000a            if (control.hasOwnProperty("input")) {\u000a                var attributeToInt = function(obj, key, def) {\u000a                    if (obj.hasOwnProperty(key)) {\u000a                        var val = obj[key];\u000a                        if (_.isNumber(val)) {\u000a                            return val;\u000a                        }\u000a\u000a                        var parsedVal = parseInt(val);\u000a                        if (!isNaN(parsedVal)) {\u000a                            return parsedVal;\u000a                        }\u000a                    }\u000a                    return def;\u000a                };\u000a\u000a                _.each(control.input, function (element) {\u000a                    if (element.hasOwnProperty("slider") && _.isObject(element.slider)) {\u000a                        element.slider["min"] = attributeToInt(element.slider, "min", 0);\u000a                        element.slider["max"] = attributeToInt(element.slider, "max", 255);\u000a\u000a                        // try defaultValue, default to min\u000a                        var defaultValue = attributeToInt(element, "default", element.slider.min);\u000a\u000a                        // if default value is not within range of min and max, correct that\u000a                        if (!_.inRange(defaultValue, element.slider.min, element.slider.max)) {\u000a                            // use bound closer to configured default value\u000a                            defaultValue = defaultValue < element.slider.min ? element.slider.min : element.slider.max;\u000a                        }\u000a\u000a                        element.value = ko.observable(defaultValue);\u000a                    } else {\u000a                        element.slider = false;\u000a                        element.value = ko.observable((element.hasOwnProperty("default")) ? element["default"] : undefined);\u000a                    }\u000a                });\u000a            }\u000a\u000a            if (control.hasOwnProperty("javascript")) {\u000a                var js = control.javascript;\u000a\u000a                // if js is a function everything's fine already, but if it's a string we need to eval that first\u000a                if (!_.isFunction(js)) {\u000a                    control.javascript = function (data) {\u000a                        eval(js);\u000a                    };\u000a                }\u000a            }\u000a\u000a            if (control.hasOwnProperty("enabled")) {\u000a                var enabled = control.enabled;\u000a\u000a                // if js is a function everything's fine already, but if it's a string we need to eval that first\u000a                if (!_.isFunction(enabled)) {\u000a                    control.enabled = function (data) {\u000a                        return eval(enabled);\u000a                    }\u000a                }\u000a            }\u000a\u000a            if (!control.hasOwnProperty("additionalClasses")) {\u000a                control.additionalClasses = "";\u000a            }\u000a\u000a            control.processed = true;\u000a            return control;\u000a        };\u000a\u000a        self.isCustomEnabled = function (data) {\u000a            if (data.hasOwnProperty("enabled")) {\u000a                return data.enabled(data);\u000a            } else {\u000a                return self.isOperational() && self.loginState.isUser();\u000a            }\u000a        };\u000a\u000a        self.clickCustom = function (data) {\u000a            var callback;\u000a            if (data.hasOwnProperty("javascript")) {\u000a                callback = data.javascript;\u000a            } else {\u000a                callback = self.sendCustomCommand;\u000a            }\u000a\u000a            if (data.confirm) {\u000a                showConfirmationDialog({\u000a                    message: data.confirm,\u000a                    onproceed: function (e) {\u000a                        callback(data);\u000a                    }\u000a                });\u000a            } else {\u000a                callback(data);\u000a            }\u000a        };\u000a\u000a        self.sendJogCommand = function (axis, multiplier, distance) {\u000a            if (typeof distance === "undefined")\u000a                distance = self.distance();\u000a            if (self.settings.printerProfiles.currentProfileData() && self.settings.printerProfiles.currentProfileData()["axes"] && self.settings.printerProfiles.currentProfileData()["axes"][axis] && self.settings.printerProfiles.currentProfileData()["axes"][axis]["inverted"]()) {\u000a                multiplier *= -1;\u000a            }\u000a\u000a            var data = {};\u000a            data[axis] = distance * multiplier;\u000a            OctoPrint.printer.jog(data);\u000a        };\u000a\u000a        self.sendHomeCommand = function (axis) {\u000a            OctoPrint.printer.home(axis);\u000a        };\u000a\u000a        self.sendFeedRateCommand = function () {\u000a            OctoPrint.printer.setFeedrate(self.feedRate());\u000a        };\u000a\u000a        self.sendExtrudeCommand = function () {\u000a            self._sendECommand(1);\u000a        };\u000a\u000a        self.sendRetractCommand = function () {\u000a            self._sendECommand(-1);\u000a        };\u000a\u000a        self.sendFlowRateCommand = function () {\u000a            OctoPrint.printer.setFlowrate(self.flowRate());\u000a        };\u000a\u000a        self._sendECommand = function (dir) {\u000a            var length = self.extrusionAmount() || self.settings.printer_defaultExtrusionLength();\u000a            OctoPrint.printer.extrude(length * dir);\u000a        };\u000a\u000a        self.sendSelectToolCommand = function (data) {\u000a            if (!data || !data.key()) return;\u000a\u000a            OctoPrint.printer.selectTool(data.key());\u000a        };\u000a\u000a        self.sendCustomCommand = function (command) {\u000a            if (!command) return;\u000a\u000a            var parameters = {};\u000a            if (command.hasOwnProperty("input")) {\u000a                _.each(command.input, function (input) {\u000a                    if (!input.hasOwnProperty("parameter") || !input.hasOwnProperty("value")) {\u000a                        return;\u000a                    }\u000a\u000a                    parameters[input.parameter] = input.value();\u000a                });\u000a            }\u000a\u000a            if (command.hasOwnProperty("command") || command.hasOwnProperty("commands")) {\u000a                var commands = command.commands || [command.command];\u000a                OctoPrint.control.sendGcodeWithParameters(commands, parameters);\u000a            } else if (command.hasOwnProperty("script")) {\u000a                var script = command.script;\u000a                var context = command.context || {};\u000a                OctoPrint.control.sendGcodeScriptWithParameters(script, context, parameters);\u000a            }\u000a        };\u000a\u000a        self.displayMode = function (customControl) {\u000a            if (customControl.hasOwnProperty("children")) {\u000a                if (customControl.name) {\u000a                    return "customControls_containerTemplate_collapsable";\u000a                } else {\u000a                    return "customControls_containerTemplate_nameless";\u000a                }\u000a            } else {\u000a                return "customControls_controlTemplate";\u000a            }\u000a        };\u000a\u000a        self.rowCss = function (customControl) {\u000a            var span = "span2";\u000a            var offset = "";\u000a            if (customControl.hasOwnProperty("width")) {\u000a                span = "span" + customControl.width;\u000a            }\u000a            if (customControl.hasOwnProperty("offset")) {\u000a                offset = "offset" + customControl.offset;\u000a            }\u000a            return span + " " + offset;\u000a        };\u000a\u000a        self.onStartup = function () {\u000a            self.requestData();\u000a        };\u000a\u000a        self._disableWebcam = function() {\u000a            // only disable webcam stream if tab is out of focus for more than 5s, otherwise we might cause\u000a            // more load by the constant connection creation than by the actual webcam stream\u000a\u000a            // safari bug doesn't release the mjpeg stream, so we just disable this for safari.\u000a            if (OctoPrint.coreui.browser.safari) {\u000a                return;\u000a            }\u000a\u000a            var timeout = self.settings.webcam_streamTimeout() || 5;\u000a            self.webcamDisableTimeout = setTimeout(function () {\u000a                log.debug("Unloading webcam stream");\u000a                $("#webcam_image").attr("src", "");\u000a                self.webcamLoaded(false);\u000a            }, timeout * 1000);\u000a        };\u000a\u000a        self._enableWebcam = function() {\u000a            if (OctoPrint.coreui.selectedTab != "#control" || !OctoPrint.coreui.browserTabVisible) {\u000a                return;\u000a            }\u000a\u000a            if (self.webcamDisableTimeout != undefined) {\u000a                clearTimeout(self.webcamDisableTimeout);\u000a            }\u000a            var webcamImage = $("#webcam_image");\u000a            var currentSrc = webcamImage.attr("src");\u000a\u000a            // safari bug doesn't release the mjpeg stream, so we just set it up the once\u000a            if (OctoPrint.coreui.browser.safari && currentSrc != undefined) {\u000a                return;\u000a            }\u000a\u000a            var newSrc = self.settings.webcam_streamUrl();\u000a            if (currentSrc != newSrc) {\u000a                if (newSrc.lastIndexOf("?") > -1) {\u000a                    newSrc += "&";\u000a                } else {\u000a                    newSrc += "?";\u000a                }\u000a                newSrc += new Date().getTime();\u000a\u000a                self.webcamLoaded(false);\u000a                self.webcamError(false);\u000a                webcamImage.attr("src", newSrc);\u000a            }\u000a        };\u000a\u000a        self.onWebcamLoaded = function() {\u000a            if (self.webcamLoaded()) return;\u000a\u000a            log.debug("Webcam stream loaded");\u000a            self.webcamLoaded(true);\u000a            self.webcamError(false);\u000a        };\u000a\u000a        self.onWebcamErrored = function() {\u000a            log.debug("Webcam stream failed to load/disabled");\u000a            self.webcamLoaded(false);\u000a            self.webcamError(true);\u000a        };\u000a\u000a        self.onTabChange = function (current, previous) {\u000a            if (current == "#control") {\u000a                self._enableWebcam();\u000a            } else if (previous == "#control") {\u000a                self._disableWebcam();\u000a            }\u000a        };\u000a\u000a        self.onBrowserTabVisibilityChange = function(status) {\u000a            if (status) {\u000a                self._enableWebcam();\u000a            } else {\u000a                self._disableWebcam();\u000a            }\u000a        };\u000a\u000a        self.onAllBound = function (allViewModels) {\u000a            var additionalControls = [];\u000a            callViewModels(allViewModels, "getAdditionalControls", function(method) {\u000a                additionalControls = additionalControls.concat(method());\u000a            });\u000a            if (additionalControls.length > 0) {\u000a                self.additionalControls = additionalControls;\u000a                self.rerenderControls();\u000a            }\u000a            self._enableWebcam();\u000a        };\u000a\u000a        self.onFocus = function (data, event) {\u000a            if (!self.settings.feature_keyboardControl()) return;\u000a            self.keycontrolActive(true);\u000a        };\u000a\u000a        self.onMouseOver = function (data, event) {\u000a            if (!self.settings.feature_keyboardControl()) return;\u000a            $("#webcam_container").focus();\u000a            self.keycontrolActive(true);\u000a        };\u000a\u000a        self.onMouseOut = function (data, event) {\u000a            if (!self.settings.feature_keyboardControl()) return;\u000a            $("#webcam_container").blur();\u000a            self.keycontrolActive(false);\u000a        };\u000a\u000a        self.toggleKeycontrolHelp = function () {\u000a            self.keycontrolHelpActive(!self.keycontrolHelpActive());\u000a        };\u000a\u000a        self.onKeyDown = function (data, event) {\u000a            if (!self.settings.feature_keyboardControl()) return;\u000a\u000a            var button = undefined;\u000a            var visualizeClick = true;\u000a\u000a            switch (event.which) {\u000a                case 37: // left arrow key\u000a                    // X-\u000a                    button = $("#control-xdec");\u000a                    break;\u000a                case 38: // up arrow key\u000a                    // Y+\u000a                    button = $("#control-yinc");\u000a                    break;\u000a                case 39: // right arrow key\u000a                    // X+\u000a                    button = $("#control-xinc");\u000a                    break;\u000a                case 40: // down arrow key\u000a                    // Y-\u000a                    button = $("#control-ydec");\u000a                    break;\u000a                case 49: // number 1\u000a                case 97: // numpad 1\u000a                    // Distance 0.1\u000a                    button = $("#control-distance01");\u000a                    visualizeClick = false;\u000a                    break;\u000a                case 50: // number 2\u000a                case 98: // numpad 2\u000a                    // Distance 1\u000a                    button = $("#control-distance1");\u000a                    visualizeClick = false;\u000a                    break;\u000a                case 51: // number 3\u000a                case 99: // numpad 3\u000a                    // Distance 10\u000a                    button = $("#control-distance10");\u000a                    visualizeClick = false;\u000a                    break;\u000a                case 52: // number 4\u000a                case 100: // numpad 4\u000a                    // Distance 100\u000a                    button = $("#control-distance100");\u000a                    visualizeClick = false;\u000a                    break;\u000a                case 33: // page up key\u000a                case 87: // w key\u000a                    // z lift up\u000a                    button = $("#control-zinc");\u000a                    break;\u000a                case 34: // page down key\u000a                case 83: // s key\u000a                    // z lift down\u000a                    button = $("#control-zdec");\u000a                    break;\u000a                case 36: // home key\u000a                    // xy home\u000a                    button = $("#control-xyhome");\u000a                    break;\u000a                case 35: // end key\u000a                    // z home\u000a                    button = $("#control-zhome");\u000a                    break;\u000a                default:\u000a                    event.preventDefault();\u000a                    return false;\u000a            }\u000a\u000a            if (button === undefined) {\u000a                return false;\u000a            } else {\u000a                event.preventDefault();\u000a                if (visualizeClick) {\u000a                    button.addClass("active");\u000a                    setTimeout(function () {\u000a                        button.removeClass("active");\u000a                    }, 150);\u000a                }\u000a                button.click();\u000a            }\u000a        };\u000a\u000a        self.stripDistanceDecimal = function(distance) {\u000a            return distance.toString().replace(".", "");\u000a        };\u000a\u000a    }\u000a\u000a    OCTOPRINT_VIEWMODELS.push({\u000a        construct: ControlViewModel,\u000a        dependencies: ["loginStateViewModel", "settingsViewModel"],\u000a        elements: ["#control"]\u000a    });\u000a});\u000a\u000a;\u000a
p0
.